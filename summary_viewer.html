<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EVM Block Profiler â€“ Summary Viewer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a21;
      --muted: #9aa4b2;
      --fg: #e5e7eb;
      --accent: #4f46e5;
      --accent2: #22c55e;
      --card: #1f2430;
      --border: #2b3240;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0 16px 60px;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #0f1115, #0b0d11);
      color: var(--fg);
    }
    header {
      position: sticky;
      top: 0;
      background: rgba(15,17,21,0.8);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      z-index: 10;
      padding: 14px 0 10px;
    }
    .wrap { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 8px 0 0; font-size: 22px; font-weight: 700; letter-spacing: .2px; }
    p.small { color: var(--muted); margin: 6px 0 0; font-size: 13px; }
    .toolbar {
      display:flex; gap:10px; align-items:center; margin:14px 0 0;
      flex-wrap: wrap;
    }
    .filebox {
      display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid var(--border);
      border-radius:10px; background: var(--panel);
    }
    input[type="file"] { color: var(--fg); }
    .kpis { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:12px; margin-top:16px; }
    .kpi { background: var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .kpi .label { color: var(--muted); font-size:12px; }
    .kpi .value { font-size:22px; font-weight:700; margin-top:4px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; margin-top:18px; }
    .panel { background: var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
    .panel h2 { margin:0 0 10px; font-size:18px; }
    .flex { display:flex; gap:16px; flex-wrap: wrap; }
    .grow { flex:1; min-width: 320px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid var(--border); font-size: 13px; }
    th { text-align:left; color: var(--muted); font-weight:600; }
    tr:hover { background: rgba(255,255,255,0.03); }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; background: #0e7490; font-size:12px; }
    .muted { color: var(--muted); }
    .footer-note { color: var(--muted); margin-top:16px; font-size:12px; }
    .dropzone {
      border:2px dashed var(--border); border-radius:12px; padding:22px; text-align:center; color:var(--muted);
    }
    .dropzone.dragover { border-color: var(--accent); background: rgba(79,70,229,0.08); color:#c7d2fe; }
    .btn {
      border:1px solid var(--border); background: var(--panel); color: var(--fg);
      padding:10px 12px; border-radius:10px; cursor:pointer;
    }
    .btn.primary { background: var(--accent); border-color: #3f3ab6; }
    .tag { font-size: 12px; color: var(--muted); }
    code { background: #0c0f14; border:1px solid var(--border); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ðŸ“Š EVM Block Profiler â€” Summary Viewer</h1>
      <p class="small">Open a <code>summary.json</code> produced by <code>block_profiler.py</code> and get instant visuals. Works fully offline.</p>
      <div class="toolbar">
        <label class="filebox">
          <strong>Load summary.json</strong>
          <input id="fileInput" type="file" accept="application/json,.json" />
        </label>
        <button id="demoBtn" class="btn">Load demo</button>
        <span class="tag">Tip: you can also drag &amp; drop a JSON file anywhere</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="dropzone" class="dropzone" style="display:none;">Drop your <strong>summary.json</strong> here</section>

    <section class="kpis" id="kpis"></section>

    <section class="grid">
      <div class="panel">
        <h2>Transaction types</h2>
        <div class="flex">
          <div class="grow">
            <canvas id="txCountChart" height="240"></canvas>
          </div>
          <div class="grow">
            <canvas id="txShareChart" height="240"></canvas>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>By type (counts, gas, value)</h2>
        <div style="overflow:auto;">
          <table id="typesTable">
            <thead>
              <tr>
                <th>Type</th>
                <th>Count</th>
                <th>Gas used</th>
                <th>Avg gas price (gwei)</th>
                <th>ETH value sum</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h2>Top contracts by tx count</h2>
        <div style="overflow:auto;">
          <table id="contractsTable">
            <thead>
              <tr><th>#</th><th>Contract</th><th>Tx count</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h2>Top tokens by events</h2>
        <div style="overflow:auto;">
          <table id="tokensTable">
            <thead>
              <tr><th>#</th><th>Token (address)</th><th>Events</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="footer-note">Token symbols/names can be resolved in the React UI via your RPC (see <code>react_block_profiler.jsx</code>).</p>
      </div>
    </section>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const kpisEl = $("#kpis");
    const fileInput = $("#fileInput");
    const dropzone = $("#dropzone");
    const demoBtn = $("#demoBtn");

    let txCountChart, txShareChart;

    function reset() {
      kpisEl.innerHTML = "";
      $("#typesTable tbody").innerHTML = "";
      $("#contractsTable tbody").innerHTML = "";
      $("#tokensTable tbody").innerHTML = "";
      if (txCountChart) { txCountChart.destroy(); txCountChart = null; }
      if (txShareChart) { txShareChart.destroy(); txShareChart = null; }
    }

    function fmtNum(n) {
      if (n === null || n === undefined || Number.isNaN(n)) return "â€”";
      return new Intl.NumberFormat(undefined, { maximumFractionDigits: 6 }).format(n);
    }

    function renderKPIs(d) {
      const items = [
        ["Blocks", d.block_count],
        ["Total tx", d.total_tx],
        ["Chain ID", d.chain_id],
        ["ETH transferred", `${fmtNum(d.total_eth_transferred_eth)} ETH`],
        ["Internal value", `${fmtNum(d.total_internal_value_eth)} ETH`],
        ["Range", `${d.start_block} â€“ ${d.end_block}`],
      ];
      const html = items.map(([label, value]) => `
        <div class="kpi">
          <div class="label">${label}</div>
          <div class="value">${value}</div>
        </div>
      `).join("");
      kpisEl.innerHTML = html;
    }

    function renderTypeTable(d) {
      const tbody = $("#typesTable tbody");
      const entries = Object.entries(d.tx_types || {}).sort((a,b)=> a[0].localeCompare(b[0]));
      let html = "";
      for (const [t, v] of entries) {
        html += `<tr>
          <td><span class="pill">${t}</span></td>
          <td>${fmtNum(v.count)}</td>
          <td>${fmtNum(v.gas_used)}</td>
          <td>${fmtNum(v.avg_gas_price_gwei)}</td>
          <td>${fmtNum(v.eth_value_sum_eth)} ETH</td>
        </tr>`;
      }
      tbody.innerHTML = html;
    }

    function renderTopTables(d) {
      const cBody = $("#contractsTable tbody");
      const tBody = $("#tokensTable tbody");
      let htmlC = "", htmlT = "";
      (d.top_contracts_by_tx || []).forEach(([addr, n], i) => {
        htmlC += `<tr><td>${i+1}</td><td><code>${addr}</code></td><td>${fmtNum(n)}</td></tr>`;
      });
      (d.top_tokens_by_events || []).forEach(([addr, n], i) => {
        htmlT += `<tr><td>${i+1}</td><td><code>${addr}</code></td><td>${fmtNum(n)}</td></tr>`;
      });
      cBody.innerHTML = htmlC;
      tBody.innerHTML = htmlT;
    }

    function renderCharts(d) {
      const ctx1 = document.getElementById("txCountChart");
      const ctx2 = document.getElementById("txShareChart");
      const entries = Object.entries(d.tx_types || {}).sort((a,b)=> a[0].localeCompare(b[0]));
      const labels = entries.map(([t]) => t);
      const counts = entries.map(([,v]) => v.count || 0);
      const total = counts.reduce((a,b)=>a+b,0) || 1;
      const shares = counts.map(c => (c/total)*100);

      txCountChart = new Chart(ctx1, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Tx count",
            data: counts,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true }, tooltip: { intersect:false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      txShareChart = new Chart(ctx2, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            label: "Share %",
            data: shares,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "right" },
            tooltip: { callbacks: { label: (ctx)=> `${ctx.label}: ${fmtNum(ctx.parsed)}%` } }
          },
          cutout: "55%"
        }
      });
    }

    function handleData(d) {
      reset();
      renderKPIs(d);
      renderTypeTable(d);
      renderTopTables(d);
      renderCharts(d);
      window.__summary = d;
    }

    function loadFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const d = JSON.parse(reader.result);
          handleData(d);
        } catch (e) {
          alert("Invalid JSON file");
          console.error(e);
        }
      };
      reader.readAsText(file);
    }

    // File input
    fileInput.addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if (f) loadFile(f);
    });

    // Drag & drop
    function showDrop(how) {
      dropzone.style.display = how ? "block" : "none";
    }
    document.addEventListener("dragover", (e)=>{ e.preventDefault(); dropzone.classList.add("dragover"); showDrop(true); });
    document.addEventListener("dragleave", (e)=>{ e.preventDefault(); dropzone.classList.remove("dragover"); });
    document.addEventListener("drop", (e)=>{
      e.preventDefault(); dropzone.classList.remove("dragover"); showDrop(false);
      const f = e.dataTransfer?.files?.[0];
      if (f) loadFile(f);
    });

    // Demo button (small inline payload)
    const demoPayload = {
      "start_block": 21000000, "end_block": 21000100, "chain_id": 1, "block_count": 101,
      "total_tx": 12345, "total_eth_transferred_eth": 321.456, "total_internal_value_eth": 42.42,
      "tx_types": {
        "contract_creation": {"count":120, "gas_used": 9_800_000, "avg_gas_price_gwei": 14.2, "eth_value_sum_eth": 0.0},
        "erc20_transfer":   {"count":7800,"gas_used": 210_000_000, "avg_gas_price_gwei": 12.7, "eth_value_sum_eth": 180.33},
        "erc721_transfer":  {"count":600, "gas_used": 45_000_000,  "avg_gas_price_gwei": 16.1, "eth_value_sum_eth": 0.0},
        "erc1155_transfer": {"count":90,  "gas_used": 8_000_000,   "avg_gas_price_gwei": 11.9, "eth_value_sum_eth": 0.0},
        "other_contract_call":{"count":4200,"gas_used": 320_000_000,"avg_gas_price_gwei": 13.5, "eth_value_sum_eth": 141.12},
        "mixed_token_activity":{"count":420,"gas_used": 38_000_000,"avg_gas_price_gwei": 13.9, "eth_value_sum_eth": 0.01},
        "eth_transfer":     {"count":115,"gas_used": 2_300_000,    "avg_gas_price_gwei": 10.1, "eth_value_sum_eth": 0.99},
        "other_eoa_call":   {"count":0,   "gas_used": 0,           "avg_gas_price_gwei": 0.0,  "eth_value_sum_eth": 0.0}
      },
      "top_contracts_by_tx": [["0xUniswapV3...", 1200], ["0xLido...", 980], ["0x0Exchange...", 740]],
      "top_tokens_by_events": [["0xUSDC...", 2100], ["0xUSDT...", 1800], ["0xWETH...", 900]]
    };
    demoBtn.addEventListener("click", ()=> handleData(demoPayload));
  </script>
</body>
</html>
